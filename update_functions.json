{
    "file": "functions.php",
    "code": "<?php\n/**\n * Child theme functions\n */\n\nadd_action( 'wp_enqueue_scripts', 'blocksy_child_enqueue_styles' );\nfunction blocksy_child_enqueue_styles() {\n\twp_enqueue_style( 'parent-style', get_template_directory_uri() . '/style.css' );\n}\n\n// --- Antigravity Agent Connector Extensions ---\n\nadd_action('rest_api_init', function () {\n    register_rest_route('antigravity/v1', '/get-theme-file', array(\n        'methods'  => 'GET',\n        'callback' => function($request) {\n            $file = sanitize_text_field($request['file']);\n            $path = get_stylesheet_directory() . '/' . $file;\n            if (!file_exists($path)) return new WP_Error('not_found', 'File not found', ['status' => 404]);\n            return ['code' => file_get_contents($path)];\n        },\n        'permission_callback' => function () { return current_user_can('edit_theme_options'); }\n    ));\n\n    register_rest_route('antigravity/v1', '/checkout-payment', array(\n        'methods'  => 'POST',\n        'callback' => 'ag_headless_checkout_handler',\n        'permission_callback' => '__return_true'\n    ));\n});\n\nfunction ag_headless_checkout_handler($request) {\n    $params = $request->get_json_params();\n    $token = $params['stripe_token'];\n    $order_data = $params['order_data'];\n\n    if (empty($token)) return new WP_Error('missing_token', 'Stripe token missing', ['status' => 400]);\n\n    // Force include WC core if not loaded\n    if (!function_exists('wc_create_order')) return new WP_Error('no_wc', 'WooCommerce not active', ['status' => 500]);\n\n    try {\n        // 1. Create Order\n        $order = wc_create_order();\n        \n        // 2. Add Products\n        foreach ($order_data['line_items'] as $item) {\n            $product_id = $item['product_id'];\n            $qty = $item['quantity'];\n            $order->add_product(get_product($product_id), $qty, [\n                'variation' => isset($item['variation_id']) ? $item['variation_id'] : []\n            ]);\n        }\n\n        // 3. Set Addresses\n        $order->set_address($order_data['billing'], 'billing');\n        $order->set_address($order_data['shipping'], 'shipping');\n        $order->set_payment_method('stripe');\n        $order->set_payment_method_title('Stripe (Cards)');\n\n        // 4. Calculate Totals\n        $order->calculate_totals();\n        \n        // 5. Save\n        $order->save();\n\n        // 6. Process Payment via Stripe Plugin\n        if (class_exists('WC_Gateway_Stripe')) {\n            $gateway = new WC_Gateway_Stripe();\n            $_POST['stripe_token'] = $token;\n            $result = $gateway->process_payment($order->get_id());\n\n            if ($result['result'] === 'success') {\n                return ['success' => true, 'order_id' => $order->get_id()];\n            } else {\n                return new WP_Error('payment_failed', 'Charge refused', ['status' => 402]);\n            }\n        }\n        \n        return new WP_Error('no_stripe', 'Stripe plugin missing on WP', ['status' => 500]);\n    } catch (Exception $e) {\n        return new WP_Error('error', $e->getMessage(), ['status' => 500]);\n    }\n}\n"
}