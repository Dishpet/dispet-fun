{"file":"functions.php","code":"<?php\r\n/**\r\n * Child theme functions\r\n */\r\n\r\nadd_action( 'wp_enqueue_scripts', 'blocksy_child_enqueue_styles' );\r\nfunction blocksy_child_enqueue_styles() {\r\n\twp_enqueue_style( 'parent-style', get_template_directory_uri() . '/style.css' );\r\n}\r\n\r\n// --- Antigravity Agent Connector Extensions ---\r\n\r\nadd_action('rest_api_init', function () {\r\n    register_rest_route('antigravity/v1', '/get-theme-file', array(\r\n        'methods'  => 'GET',\r\n        'callback' => function($request) {\r\n            $file = sanitize_text_field($request['file']);\r\n            $path = get_stylesheet_directory() . '/' . $file;\r\n            if (!file_exists($path)) return new WP_Error('not_found', 'File not found', ['status' => 404]);\r\n            return ['code' => file_get_contents($path)];\r\n        },\r\n        'permission_callback' => function () { return current_user_can('edit_theme_options'); }\r\n    ));\r\n\r\n    register_rest_route('antigravity/v1', '/checkout-payment', array(\r\n        'methods'  => 'POST',\r\n        'callback' => 'ag_headless_checkout_handler',\r\n        'permission_callback' => '__return_true'\r\n    ));\r\n});\r\n\r\nfunction ag_headless_checkout_handler($request) {\r\n    $params = $request->get_json_params();\r\n    $token = $params['stripe_token'];\r\n    $order_data = $params['order_data'];\r\n\r\n    if (empty($token)) return new WP_Error('missing_token', 'Stripe token missing', ['status' => 400]);\r\n    if (!function_exists('wc_create_order')) return new WP_Error('no_wc', 'WooCommerce not active', ['status' => 500]);\r\n\r\n    try {\r\n        // 1. Create Order\r\n        $order = wc_create_order();\r\n        \r\n        // 2. Add Products\r\n        foreach ($order_data['line_items'] as $item) {\r\n            $product_id = $item['product_id'];\r\n            $qty = $item['quantity'];\r\n            $order->add_product(get_product($product_id), $qty, [\r\n                'variation' => isset($item['variation_id']) ? $item['variation_id'] : []\r\n            ]);\r\n        }\r\n\r\n        // 3. Set Addresses and Customer\r\n        $order->set_address($order_data['billing'], 'billing');\r\n        $order->set_address($order_data['shipping'], 'shipping');\r\n        if (!empty($order_data['customer_id'])) {\r\n            $order->set_customer_id($order_data['customer_id']);\r\n        }\r\n\r\n        $order->set_payment_method('stripe');\r\n        $order->set_payment_method_title('Stripe (Cards)');\r\n        $order->calculate_totals();\r\n        $order->save();\r\n\r\n        // 4. Process Payment via Stripe Plugin\r\n        if (class_exists('WC_Gateway_Stripe')) {\r\n            $gateway = new WC_Gateway_Stripe();\r\n            \r\n            // Mock GLOBAL POST for the gateway to see the token\r\n            $_POST['stripe_token'] = $token;\r\n            $_POST['stripe_source'] = $token;\r\n            $_POST['payment_method'] = 'stripe';\r\n            \r\n            $result = $gateway->process_payment($order->get_id());\r\n\r\n            // Return the FULL result (including redirect URL if 3DSecure is needed)\r\n            if (isset($result['result']) && $result['result'] === 'success') {\r\n                return [\r\n                    'success' => true,\r\n                    'order_id' => $order->get_id(),\r\n                    'redirect' => $result['redirect'] ?? null,\r\n                    'result_payload' => $result\r\n                ];\r\n            } else {\r\n                // Failed payment - Return proper error message from Gateway\r\n                $order->update_status('failed', 'Headless Payment Failed');\r\n                \r\n                // Extract specific error message if available\r\n                $errorMessage = isset($result['messages']) ? $result['messages'] : 'Payment processing failed. Please try again.';\r\n                // Sometimes it is in a different format depending on plugin version\r\n                if (method_exists($gateway, 'get_validation_errors')) {\r\n                    $validation_errors = $gateway->get_validation_errors();\r\n                    if (!empty($validation_errors)) {\r\n                         $errorMessage = is_array($validation_errors) ? implode(' ', $validation_errors) : $validation_errors;\r\n                    }\r\n                }\r\n                \r\n                // Try to find error in notices if messages is empty\r\n                if (function_exists('wc_get_notices')) {\r\n                     $notices = wc_get_notices('error');\r\n                     if (!empty($notices)) {\r\n                         $errorMessage .= \" \" . implode(\" \", array_map('strip_tags', $notices));\r\n                         wc_clear_notices();\r\n                     }\r\n                }\r\n\r\n                return new WP_Error('payment_failed', $errorMessage, ['status' => 402, 'gateway_result' => $result]);\r\n            }\r\n        }\r\n        \r\n        return new WP_Error('no_stripe', 'Stripe plugin missing on WP', ['status' => 500]);\r\n    } catch (Exception $e) {\r\n        return new WP_Error('error', $e->getMessage(), ['status' => 500]);\r\n    }\r\n}\r\n"}